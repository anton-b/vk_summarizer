from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate, PromptTemplate
from langchain_core.messages import HumanMessage, AIMessage

model = ChatOllama(
    base_url="http://172.29.144.1:11434",
    # model="deepseek-r1:14b",
    # model="phi4:latest",
    model="gemma3:12b",
    # model="llama3.1:8b",
    num_predict=30000,
    # seed=42,
    # temperature=0.01,
)


def system_template(instruction):
    return ChatPromptTemplate([("system", instruction), ("user", "{chat_messages}")])

def simple_prompt(instruction):
    return PromptTemplate(
        template=instruction,
    )

def blog_bot():
    instruction = """
        –¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∏ –≤–µ—Å—ë–ª—ã–π –ø–æ–º–æ—à–Ω–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥—Ä—É–∑–µ–π –≤ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–≥-–ø–æ—Å—Ç.
        –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–æ–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –ª—ë–≥–∫–∏–º –¥–ª—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è.
        –ù–µ –∑–∞–±—ã–≤–∞–π, —á—Ç–æ —ç—Ç–æ –±–ª–æ–≥-–ø–æ—Å—Ç, –ø–æ—ç—Ç–æ–º—É —Å—Ç–∞—Ä–∞–π—Å—è —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª–µ–π.
        
        **–¢–≤–æ—è –∑–∞–¥–∞—á–∞** –Ω–∞–ø–∏—Å–∞—Ç—å –±–ª–æ–≥ –ø–æ—Å—Ç –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥—Ä—É–∑–µ–π
        
        **–§–æ—Ä–º–∞—Ç**
        
        - –ó–∞–≥–æ–ª–æ–≤–æ–∫.
        - –ö—Ç–æ –æ–±—â–∞–ª—Å—è –≤ —á–∞—Ç–µ, –∫—Ç–æ –æ–Ω–∏ –∏ –∫–∞–∫ –∏—Ö –∑–æ–≤—É—Ç.
        - –í–≤–µ–¥–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–∏–Ω—Ç—Ä–∏–≥—É–µ—Ç —á–∏—Ç–∞—Ç–µ–ª—è –∏ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ.
        - –û—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.        
        - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞, –∫—Ç–æ –æ–Ω–∏ –∏ –∫–∞–∫ –∏—Ö –∑–æ–≤—É—Ç.
        - –ù–µ –≤—ã–¥–µ–ª—è–π –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.
        - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥–≤–µ–¥—ë—Ç –∏—Ç–æ–≥ –≤—Å–µ–º—É —Å–∫–∞–∑–∞–Ω–Ω–æ–º—É –∏ –æ—Å—Ç–∞–≤–∏—Ç —á–∏—Ç–∞—Ç–µ–ª—è —Å —Ö–æ—Ä–æ—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º.

        –í–æ—Ç –∏—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã:

        ```
        {chat_messages}
        ```
        **–í–∞–∂–Ω–æ** –ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
        **–í–∞–∂–Ω–æ** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –¥–∞—Ç—É –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª —á–∞—Ç.
        **–í–∞–∂–Ω–æ** –Ω–µ –¥–µ–ª–∞–π –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, —Ç–∏–ø–∞ "–û–∫–µ–π –≤–æ—Ç –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞" –∏–ª–∏ "–í–æ—Ç —á—Ç–æ —è –Ω–∞—à—ë–ª –≤ —á–∞—Ç–µ", –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –±–ª–æ–≥ –ø–æ—Å—Ç.
        **–í–∞–∂–Ω–æ** –í –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –∫—Ç–æ –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–∞–º—ã–π –≤—ã—ë–±–∏—Å—Ç—ã–π –∏ –¥–∞–π —Ç–∞–∫–æ–º—É —ç–º–æ–¥–∑–∏ –º–µ–¥–∞–ª—å–∫—É üèÖ
    """
    return simple_prompt(instruction) | model


def povest_bot():
    instruction = """
**–†–æ–ª—å**: –¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –∏ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–≤–µ—Å—Ç–µ–π.
**–¶–µ–ª—å**: –ù–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –¥—Ä—É–∑–µ–π —Ç—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ—à—å —á–∞—Ç –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—É—é, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∏ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø–æ–≤–µ—Å—Ç—å.
**–°—Ç–∏–ª—å**: –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –∂–∏–≤–æ–π –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–æ–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø–æ–≤–µ—Å—Ç—å –ª—ë–≥–∫–æ–π –¥–ª—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –∏ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ–π.
**–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞**: –ü–æ–≤–µ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ–π, –Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–π —Ç—Ä–∞–≥–∏–∑–º–æ–º ‚Äî –¥–æ–±–∞–≤–ª—è–π –º–æ–º–µ–Ω—Ç—ã –∏—Ä–æ–Ω–∏–∏, –Ω–µ–ª–æ–≤–∫–æ—Å—Ç–∏, —Ç–µ–ø–ª–æ—Ç—ã –∏ –±–ª–∏–∑–æ—Å—Ç–∏, –∫–∞–∫ —ç—Ç–æ –±—ã–≤–∞–µ—Ç –º–µ–∂–¥—É –¥—Ä—É–∑—å—è–º–∏.
**–§–æ—Ä–º–∞—Ç**:

* –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –¥–∏–∞–ª–æ–≥–∏ –≤ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–ø–ª–∏–∫–∞–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.
* –î–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏—è —ç–º–æ—Ü–∏–π, –ø–∞—É–∑, –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π, —á—Ç–æ–±—ã –æ–∂–∏–≤–∏—Ç—å —Å—Ü–µ–Ω—ã.
* –ò—Å–ø–æ–ª—å–∑—É–π –∏–º–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–æ—Ö—Ä–∞–Ω—è—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ.
* –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ–≤–µ—Å—Ç—å –ø–æ —Å—Ü–µ–Ω–∞–º, –≥–ª–∞–≤–∞–º –∏–ª–∏ —ç–ø–∏–∑–æ–¥–∞–º, –µ—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –æ–±—ä—ë–º–Ω—ã–π.
* –ò–∑–±–µ–≥–∞–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ-–∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ ‚Äî —Å—Ç–∏–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∂–∏–≤—ã–º, –ø–æ—á—Ç–∏ –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã–º.

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**:

* –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–µ—Ç–∞–ª–∏ (–≤–Ω–µ—à–Ω–æ—Å—Ç—å, –ª–æ–∫–∞—Ü–∏–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–Ω–æ–ª–æ–≥–∏), —á—Ç–æ–±—ã —É—Å–∏–ª–∏—Ç—å —Å—é–∂–µ—Ç.
* –£–≤–∞–∂–∞–π –æ–±—â–∏–π —Ç–æ–Ω –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî –Ω–µ –∏—Å–∫–∞–∂–∞–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–≤ –∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

**–í–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —á–∞—Ç–∞, –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ç–æ—Ä—ã—Ö –ø–∏—à–µ—à—å –ø–æ–≤–µ—Å—Ç—å.

**–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏**: –ö–æ–≥–¥–∞ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å —á–∞—Ç –¥—Ä—É–∑–µ–π, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ, –≤—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –¥–∏–Ω–∞–º–∏–∫—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π, —Å–∫—Ä—ã—Ç—ã–µ —á—É–≤—Å—Ç–≤–∞ –∏–ª–∏ –Ω–∞–º—ë–∫–∏ ‚Äî –∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–π —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –≤–∏–¥–µ —Å—Ü–µ–Ω—ã –∏–ª–∏ –≥–ª–∞–≤—ã –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–≤–µ—Å—Ç–∏.

{chat_messages}
**–í–∞–∂–Ω–æ** –ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
**–í–∞–∂–Ω–æ** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –¥–∞—Ç—É –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª —á–∞—Ç.
**–í–∞–∂–Ω–æ** –Ω–µ –¥–µ–ª–∞–π –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, —Ç–∏–ø–∞ "–û–∫–µ–π –≤–æ—Ç –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞" –∏–ª–∏ "–í–æ—Ç —á—Ç–æ —è –Ω–∞—à—ë–ª –≤ —á–∞—Ç–µ", –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ —Å–º–µ—Å—å –±–ª–æ–≥ –ø–æ—Å—Ç–∞ –∏ –ø–æ–≤–µ—Å—Ç–∏.
**–í–∞–∂–Ω–æ** –í –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –∫—Ç–æ –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–∞–º—ã–π –≤—ã—ë–±–∏—Å—Ç—ã–π –∏ –¥–∞–π —Ç–∞–∫–æ–º—É —ç–º–æ–¥–∑–∏ –º–µ–¥–∞–ª—å–∫—É üèÖ
**–í–∞–∂–Ω–æ** –ù–∞—á–∏–Ω–∞–π –≤—Å–µ–≥–¥–∞ —Ç–∞–∫: "–ê –≤–æ—Ç –∏ –Ω–æ–≤–æ–µ —Å–ª—É—á–∞–π–Ω–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ —á–∞—Ç–∏–∫–∞ –æ—Ç –±–æ—Ç–∞-–µ–±–æ–±–æ—Ç–∞ –æ—Ç <–¥–∞—Ç–∞>":    
    """
    return simple_prompt(instruction) | model
    

def dramatic_chat_summary(chat_messages):
    povest_template = povest_bot()
    input_data = {"chat_messages": chat_messages}
    summary = povest_template.stream(input_data, stream_mode=['messages'])
    summary_a = ""
    for summary_item in summary:
        summary_a += summary_item.content
        print(summary_item.content, end='', flush=True)
    return summary_a


def summarize_chat(chat_messages):
    blog_template = blog_bot()
    input_data = {"chat_messages": chat_messages}
    # summary = blog_template.invoke(input_data)
    summary = blog_template.stream(input_data, stream_mode=['messages'])
    summary_a = ""
    for summary_item in summary:
        summary_a += summary_item.content
        print(summary_item.content, end='', flush=True)
    return summary_a
